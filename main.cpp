#include "arlib.h"

#ifndef ARGUI_GTK3
#error gtk only
#endif

#include <gtk/gtk.h>

class widget_gtk : public widget_base { WIDGET_BASE
public:
	widget_gtk(GtkWidget* widget, uint8_t widthprio, uint8_t heightprio)
	{
		this->widget = widget;
		this->widthprio = widthprio;
		this->heightprio = heightprio;
	}
};
#define widget_create_gtk(...) (new widget_gtk(__VA_ARGS__))

GtkTextView* textview;
void do_stdin(uintptr_t fd)
{
	char line[4096];
	line[read(fd, line, 4096)] = '\0';
	gtk_text_buffer_insert_at_cursor(gtk_text_view_get_buffer(textview), line, -1);
}


int main(int argc, char * argv[])
{
	window_init(&argc, &argv);
	
	
	textview = GTK_TEXT_VIEW(gtk_text_view_new());
	gtk_text_view_set_wrap_mode(textview, GTK_WRAP_WORD_CHAR);
	
	GtkScrolledWindow* scrollview = GTK_SCROLLED_WINDOW(gtk_scrolled_window_new(NULL, NULL));
	//I don't want AUTOMATIC horizontal policy, I want NEVER
	//but without it, the textview refuses to shrink the window if that would change word wrapping
	//I probably want EXTERNAL, but it only exists since 3.16, Ubuntu 14.04 has 3.10
	gtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(scrollview), GTK_POLICY_AUTOMATIC, GTK_POLICY_AUTOMATIC);
	gtk_container_add(GTK_CONTAINER(scrollview), GTK_WIDGET(textview));
	
	
	window* wnd = window_create(
		widget_create_layout_horz(
			widget_create_layout_vert(
				widget_create_gtk(GTK_WIDGET(scrollview), 4, 4),
				widget_create_textbox()
			)
		)
	);
	
	
	wnd->set_visible(true);
	wnd->set_resizable(true, NULL);
	wnd->set_title("ЯUSSIAN MALWДRE");
	
	wnd->set_onclose(&window::exit_runloop);
	
	runloop::global()->set_fd(0, do_stdin);
	runloop::global()->enter();
	
	delete wnd;
}
