#pragma once
#include "arlib.h"

typedef struct _GtkScrolledWindow GtkScrolledWindow;
typedef struct _GtkTextView GtkTextView;
typedef struct _GtkWidget GtkWidget;
#ifdef ARGUI_GTK3
typedef union _GdkEvent GdkEvent;
#else
typedef struct _GdkEvent GdkEvent;
#endif

class inputview : nocopy {
	GtkScrolledWindow* scrollview;
	GtkTextView* view;
	
	function<void(cstring text)> onactivate;
	function<void(int x)> onmovecaret;
	
	uint32_t valid_fmt;
	
	int scrollbackpos = -1; // -1 for not in scrollback, 0 for looking at most recent message (index 0)
	array<string> scrollback;
	
	void call_onmovecaret();
	
	inputview(uint32_t valid_fmt);
	
public:
	static inputview* create(uint32_t valid_fmt) { return new inputview(valid_fmt); }
	bool onkeydown(GtkWidget* widget, GdkEvent* event);
	
	void set_onactivate(function<void(cstring text)> cb) { this->onactivate = cb; }
	void set_onmovecaret(function<void(int x)> cb) { this->onmovecaret = cb; }
	bool has_focus();
	void grab_focus();
	
	void text_prefix(cstring text);
	void text_replace(cstring text);
	
	//Sets a 'warning, you may not want to talk here right now' flag.
	void set_warning(bool warning);
	
	GtkWidget* gtkwidget();
	GtkWidget* gtkwidget_inner() { return (GtkWidget*)view; }
	
	// no explicit destructor, not needed; gtk widgets are deleted by deleting their parent, and everything else has its own destructors
};
