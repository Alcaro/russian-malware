#pragma once
#include "russian.h"

//don't know if this is guaranteed stable, but I'd rather not include the gtk header here
typedef struct _GtkTextView GtkTextView;
typedef struct _GtkTextBuffer GtkTextBuffer;
typedef struct _GtkTextTagTable GtkTextTagTable;
typedef struct _GtkTextTag GtkTextTag;
typedef struct _GtkWidget GtkWidget;
typedef struct _GdkPixbuf GdkPixbuf;

class textview : nocopy {
	GtkTextView* view;
	GtkTextTagTable* tags;
	
	GtkTextTag* t_imgalt;
	
	textview();
	
public:
	class image : nocopy {
		friend class textview;
		friend class buffer;
		GdkPixbuf* pix;
	public:
		image(arrayview<byte> bytes, size_t width, size_t height);
		~image();
	};
	struct span {
		string text;
		
		//If this is non-null, 'text' isn't shown. However, it is used; it's the alt-text if copied.
		//However, most other fields do nothing (though bgcol probably works).
		//It's perfectly fine to insert the same one in multiple messages, or multiple times in the
		// same one. Don't create multiple identical images, that's a waste of RAM.
		image* img = NULL;
		
		//Hidden text shows up if copied, but isn't normally visible. Use for formatting codes, like IRC's \x02 bold.
		//Hidden images are undefined behavior.
		bool hidden = false;
		
		bool bold = false;
		bool underline = false;
		bool italics = false;
		bool strike = false;
		
		static const uint32_t colors[16];
		uint8_t fgcol = -1;
		uint8_t bgcol = -1;
	};
	class buffer : nocopy {
		friend class textview;
		textview* parent;
		GtkTextBuffer* buf;
		
		buffer(textview* parent);
		
	public:
		//If 'id' is nonblank and has already been seen, it will be replaced.
		//The message may contain linebreaks, but should not end with one unless you actually want that.
		void message(cstring id, arrayview<span> spans);
		~buffer();
	};
	buffer* child() { return new buffer(this); }
	void set_buf(buffer* buf);
	
	static textview* create() { return new textview(); }
	//it's safe to not use GTK_WIDGET(foo), defining G_DISABLE_CAST_CHECKS replaces it with a straight cast
	GtkWidget* gtkwidget() { return (GtkWidget*)view; }
	
	~textview();
};
