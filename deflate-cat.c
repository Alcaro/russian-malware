// This program allows reading discord-cache.bin. Compile with 'gcc deflate-cat.c', nothing else needed.

#include <stdio.h>
#include "arlib/deps/miniz.c"

void dcat(FILE* f)
{
	size_t pc = 1024;
	void* p = malloc(pc);
	size_t ps = 0;
	while (!feof(f))
	{
		ps += fread(p+ps, 1,pc-ps, f);
		if (pc-ps < 512)
		{
			pc *= 2;
			p = realloc(p, pc);
		}
	}
	
	size_t decomplen;
	void* decomp = tinfl_decompress_mem_to_heap(p, ps, &decomplen, 0);
	free(p);
	
	fwrite(decomp, 1,decomplen, stdout);
	free(decomp);
}

int main(int argc, char** argv)
{
	if (argc == 2)
		dcat(fopen(argv[1], "rb")); // leak it, who cares
	else if (argc == 1)
		dcat(stdin);
	else
		puts("bad usage");
}
